steps:
  - name: gcr.io/cloud-builders/docker
    args:
      - build
      - '--file=deploy/lstep/Dockerfile'
      - '--tag=${_IMAGE_URI}'
      - '.'
  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - '${_IMAGE_URI}'
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: gcloud
    args:
      - run
      - deploy
      - ${_SERVICE_NAME}
      - '--image=${_IMAGE_URI}'
      - '--region=${_REGION}'
      - '--platform=managed'
      - '--no-allow-unauthenticated'
      - '--service-account=${_SERVICE_ACCOUNT}'
      - '--env-vars-file=deploy/lstep/env.yaml'
      - '--set-secrets=LSTEP_SMTP_PASS=LSTEP_SMTP_PASS:latest'
images:
  - '${_IMAGE_URI}'

substitutions:
  _IMAGE_URI: 'asia-northeast1-docker.pkg.dev/mark-454114/autostudio/lstep:latest'
  _SERVICE_NAME: 'autostudio-lstep'
  _REGION: 'asia-northeast1'
  _SERVICE_ACCOUNT: 'autostudio-lstep@mark-454114.iam.gserviceaccount.com'
