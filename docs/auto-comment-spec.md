# Threads投稿 自動コメント追加機能 要件定義

## 概要

投稿が一定の条件を満たした場合に、自動で特典誘導とnote記事リンクをコメント欄に追加する機能。

## 1. 投稿の伸び検知条件

以下の**いずれか1つでも満たせば**自動コメント追加を発動:

### 条件A: メイン投稿のインプレッション
- **閾値**: インプレッション数 >= 1,000

### 条件B: コメント欄1への遷移率
- **閾値**: コメント1のviews / メイン投稿のimpressions >= 10%
- 計算式: `comment1_views / post_impressions >= 0.1`

## 2. 特典誘導の有無チェック

既に特典誘導が設置されているかを以下の2点でチェック:

### チェック1: コメント欄2にURLが含まれているか
- コメント欄2(depth=1, order=2)のテキストに`http`が含まれているか確認

### チェック2: 固定ポスト誘導の文言があるか
- 以下のパターンにマッチする文言がコメント欄に含まれているか:
  - 「固定ポストで〜配ってる」
  - 「固定ポストで〜受け取ってください」
  - 正規表現: `固定ポスト.*配.*受け取`

**判定**: 上記2つのうち**いずれか1つでも該当すれば**誘導済みと判断

## 3. 自動コメント追加処理

### 3-1. 特典誘導コメント(誘導がない場合のみ)

**追加タイミング**: 特典誘導チェックでNGの場合のみ

**コメント文言**:
```
2026年最新版のThreadsノウハウはこちら▼
https://autostudio-self.vercel.app/l/th/2026

3ヶ月でフォロワー3100人増やした方法は50分の動画講座とPDF50ページで固定ポストで解説してます。
```

**追加位置**:
- コメント欄の最後に追加(depth=1)

### 3-2. note記事リンク(常に追加)

**追加タイミング**: 特典誘導の有無に関わらず、常に追加

**処理フロー**:
1. 投稿のテーマ/キーワードを抽出
2. note記事データベースから関連記事を検索
   - TODO: note記事データベースの格納場所を決定
   - データ構造: テーマ/タグ × 記事URLのマッピング
3. 最適な記事URLを取得
4. コメント文言: 「より詳しい解説はこちらです」+ 記事URL

**追加位置**:
- 特典誘導の次(または特典誘導がない場合は最後)

## 4. 実行頻度

- **チェック頻度**: 6時間ごと(既存のThreads同期タイミングと同じ)
- **対象期間**: 投稿から7日以内の投稿を監視対象とする

## 5. データ構造

### 必要なテーブル・データ

#### 5-1. 自動コメント実行履歴テーブル(新規作成)
```sql
CREATE TABLE autostudio_threads.auto_comment_history (
  post_id STRING,
  triggered_at TIMESTAMP,
  trigger_reason STRING, -- 'impressions' or 'comment_ctr'
  impressions INT64,
  comment1_ctr FLOAT64,
  has_tokuten_guide BOOL,
  tokuten_comment_added BOOL,
  note_article_url STRING,
  note_comment_added BOOL,
  created_at TIMESTAMP
)
```

#### 5-2. note記事マッピングデータ
- 格納場所: Notion (後日実装)
- Phase 2で実装予定

## 6. 実装フェーズ

### Phase 1: 基本機能
- [ ] 投稿の伸び検知ロジック
- [ ] 特典誘導チェックロジック
- [ ] comment_schedulesへの追加処理
- [ ] 実行履歴の記録

### Phase 2: note記事連携
- [ ] note記事データベース構築
- [ ] テーママッチングロジック
- [ ] note記事リンク追加処理

### Phase 3: 監視・改善
- [ ] ダッシュボードでの可視化
- [ ] 効果測定(追加後のCTRなど)
- [ ] 閾値の最適化

## 7. TODO

- [ ] 特典誘導の具体的な文言を確定
- [ ] note記事データベースの構築方法を決定
- [ ] テーママッチングのロジックを設計(AI使用 or キーワードマッチング)
